<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lobby</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <h1>Stanza</h1>
        <div id="roomCode" class="room-code"></div>

        <div class="players-list">
            <h3>Giocatori (<span id="playerCount">0</span>)</h3>
            <div id="playersList"></div>
        </div>

        <div class="button-container">
            <button id="startBtn" class="rounded-button start-button" onclick="startGame()" style="display: none;">
                Inizia Partita
            </button>
            <p id="waitingMessage" class="status-message">
                <span class="waiting-animation">In attesa che l'host avvii la partita...</span>
            </p>
        </div>

        <a class="back-link" onclick="leaveRoom()">Abbandona Stanza</a>
    </div>

    <script>
        // CONFIGURAZIONE SUPABASE
        const SUPABASE_URL = 'https://iiwcqemmtdmzzgiytlqr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_pBR3LS6E0PEXe7cbSRuu_g_JOGA9rY-';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const roomId = sessionStorage.getItem('roomId');
        const roomCode = sessionStorage.getItem('roomCode');
        const playerName = sessionStorage.getItem('playerName');
        const isHost = sessionStorage.getItem('isHost') === 'true';

        if (!roomId || !playerName) {
            window.location.href = 'join.html';
        }

        document.getElementById('roomCode').textContent = roomCode;

        if (isHost) {
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('waitingMessage').innerHTML = '<span class="waiting-animation">In attesa di altri giocatori...</span>';
        }

        let playersSubscription = null;
        let roomSubscription = null;

        async function loadPlayers() {
            const { data: players, error } = await supabaseClient
                .from('players')
                .select('*')
                .eq('room_id', roomId)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Errore caricamento giocatori:', error);
                return;
            }

            // Se non ci sono giocatori, la stanza Ã¨ vuota. Se IO non sono piÃ¹ nei giocatori, sono stato espulso.
            const me = players.find(p => p.name === playerName);
            if (!me && players.length > 0) {
                window.location.href = 'join.html';
                return;
            }

            if (players.length === 0) {
                return;
            }

            // Controlla se esiste un host
            const currentHost = players.find(p => p.is_host);

            if (!currentHost && players.length > 0) {
                // Non c'Ã¨ host - solo il primo giocatore (per ordine di creazione) 
                // tenta di diventare host per evitare race condition
                const potentialNewHost = players[0];

                // Solo se IO sono il primo giocatore, provo a diventare host
                if (potentialNewHost.name === playerName) {
                    // Uso un update condizionale: aggiorno solo se is_host Ã¨ ancora false
                    // Questo previene race condition a livello database
                    const { data: updated, error: updateError } = await supabaseClient
                        .from('players')
                        .update({ is_host: true })
                        .eq('id', potentialNewHost.id)
                        .eq('is_host', false) // Condizione: solo se non Ã¨ giÃ  host
                        .select();

                    if (!updateError && updated && updated.length > 0) {
                        // Sono diventato host con successo
                        sessionStorage.setItem('isHost', 'true');
                        window.location.reload();
                        return;
                    }
                }

                // Ricarica i giocatori per vedere chi Ã¨ diventato host
                // (aspetta un attimo per dare tempo all'altro client)
                setTimeout(() => loadPlayers(), 500);
                return;
            }

            renderPlayers(players);
        }

        function renderPlayers(players) {
            const playersList = document.getElementById('playersList');
            const playerCount = document.getElementById('playerCount');

            playerCount.textContent = players.length;
            playersList.innerHTML = '';

            players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';

                let badges = '';
                if (player.is_host) badges += '<span class="host-badge">HOST</span>';
                if (player.name === playerName) badges += '<span class="you-badge">TU</span>';

                let kickButton = '';
                // Mostra bottone kick solo se sono host e non Ã¨ il mio utente
                if (isHost && player.name !== playerName) {
                    kickButton = `<button class="kick-btn" onclick="kickPlayer('${player.id}', '${player.name}')" title="Espelli">âœ•</button>`;
                }

                div.innerHTML = `
                    <span class="player-name">${player.name}</span>
                    <div style="display:flex;align-items:center">${badges}${kickButton}</div>
                `;
                playersList.appendChild(div);
            });

            // Abilita il pulsante start solo se ci sono almeno 3 giocatori
            if (isHost) {
                const startBtn = document.getElementById('startBtn');
                startBtn.disabled = players.length < 3;
                if (players.length < 3) {
                    document.getElementById('waitingMessage').innerHTML =
                        '<span class="waiting-animation">Servono almeno 3 giocatori per iniziare...</span>';
                } else {
                    document.getElementById('waitingMessage').innerHTML =
                        '<span class="waiting-animation">Pronto per iniziare!</span>';
                }
            }
        }

        async function startGame() {
            if (!isHost) return;

            const { data: players } = await supabaseClient
                .from('players')
                .select('*')
                .eq('room_id', roomId);

            if (players.length < 3) {
                alert('Servono almeno 3 giocatori per iniziare!');
                return;
            }

            // Scegli un faker casuale (ma Simone non puÃ² mai essere il faker ðŸ˜‡)
            let faker;
            do {
                const fakerIndex = Math.floor(Math.random() * players.length);
                faker = players[fakerIndex];
            } while (faker.name === 'Simone');

            // Aggiorna il faker nel database
            await supabaseClient
                .from('players')
                .update({ is_faker: true })
                .eq('id', faker.id);

            // Salva l'ordine dei giocatori
            const playerNames = players.map(p => p.name);

            // Aggiorna lo stato della stanza
            await supabaseClient
                .from('rooms')
                .update({
                    status: 'playing',
                    player_order: playerNames,
                    current_player_index: 0
                })
                .eq('id', roomId);
        }

        async function leaveRoom() {
            if (confirm('Vuoi davvero abbandonare la stanza?')) {
                await supabaseClient
                    .from('players')
                    .delete()
                    .eq('room_id', roomId)
                    .eq('name', playerName);

                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        async function kickPlayer(playerId, playerNameKicked) {
            if (!confirm(`Vuoi espellere ${playerNameKicked} dalla stanza?`)) return;

            try {
                const { error } = await supabaseClient
                    .from('players')
                    .delete()
                    .eq('id', playerId);

                if (error) throw error;
            } catch (error) {
                console.error('Errore espulsione:', error);
                alert('Impossibile espellere il giocatore.');
            }
        }

        // Sottoscrizione in tempo reale per i giocatori
        function subscribeToPlayers() {
            playersSubscription = supabaseClient
                .channel('players-channel-' + roomId)
                .on('postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'players', filter: `room_id=eq.${roomId}` },
                    (payload) => {
                        console.log('Player joined:', payload);
                        loadPlayers();
                    }
                )
                .on('postgres_changes',
                    { event: 'DELETE', schema: 'public', table: 'players' },
                    (payload) => {
                        console.log('Player left:', payload);
                        // Se sono stato io ad essere rimosso (kick o altro), torno alla home/join
                        if (payload.old.name === playerName) {
                            alert("Sei stato rimosso dalla stanza.");
                            sessionStorage.clear();
                            window.location.href = 'join.html';
                        }
                        loadPlayers();
                    }
                )
                .on('postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'players', filter: `room_id=eq.${roomId}` },
                    (payload) => {
                        console.log('Player updated:', payload);
                        loadPlayers();
                    }
                )
                .subscribe((status) => {
                    console.log('Subscription status:', status);
                });
        }

        // Sottoscrizione in tempo reale per lo stato della stanza
        function subscribeToRoom() {
            roomSubscription = supabaseClient
                .channel('room-channel')
                .on('postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomId}` },
                    (payload) => {
                        if (payload.new.status === 'playing') {
                            window.location.href = 'online_game1.html';
                        }
                    }
                )
                .subscribe();
        }

        // Inizializzazione
        checkRoomStatus();
        loadPlayers();
        subscribeToPlayers();
        subscribeToRoom();

        async function checkRoomStatus() {
            const { data: room, error } = await supabaseClient
                .from('rooms')
                .select('status')
                .eq('id', roomId)
                .single();

            if (room && room.status === 'playing') {
                window.location.href = 'online_game1.html';
            }
        }

        // Cleanup quando si lascia la pagina
        window.addEventListener('beforeunload', () => {
            if (playersSubscription) playersSubscription.unsubscribe();
            if (roomSubscription) roomSubscription.unsubscribe();
        });
    </script>
</body>

</html>