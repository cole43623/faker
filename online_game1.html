<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Online | Faker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="domande.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6f42c1;
            --primary-dark: #4834d4;
            --accent: #ffc107;
            --bg: #f4f7f6;
            --text-dark: #2d3436;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
            background-color: var(--primary);
            background-image: linear-gradient(135deg, #6f42c1 0%, #4834d4 100%);
            color: var(--white);
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        header {
            padding: 0.8rem;
            padding-top: 3rem;
            text-align: center;
        }

        header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 1px;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.8rem 2.2rem;
            border-radius: 50px;
            display: inline-block;
            backdrop-filter: blur(10px);
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
        }

        .card {
            background: var(--white);
            color: var(--text-dark);
            width: 100%;
            max-width: 450px;
            border-radius: 30px;
            padding: 2.5rem;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: fadeInScale 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
        }

        .player-intro {
            font-size: 2rem;
            opacity: 0.7;
            margin-bottom: 1rem;
            display: block;
        }

        .question-box {
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 20px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .simone-section {
            background: #fff8e1;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--accent);
            animation: slideDown 0.4s ease both;
        }

        .simone-badge {
            background-color: var(--accent);
            color: #333;
            padding: 0.4rem 1rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: inline-block;
            text-transform: uppercase;
        }

        .btn-group-horizontal {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 18px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }

        .btn-primary:not(:disabled):hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.4);
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.8;
        }

        .btn-sm {
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            width: auto;
        }

        .btn-green {
            background: #04AA6D;
            color: white;
        }

        .btn-orange {
            background: #f39c12;
            color: white;
        }

        .btn-faker {
            background: #ff4757;
            color: white;
        }

        .progress-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #edf2f7;
        }

        .ready-count-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .waiting-text {
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 500;
            animation: pulse 1.5s infinite;
        }

        .faker-text {
            color: #d32f2f;
            font-weight: 700;
        }

        .eliminated-text {
            color: #718096;
            font-style: italic;
            opacity: 0.8;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1><span id="titolo">CARICAMENTO...</span></h1>
    </header>

    <div class="main-container">
        <div class="card">
            <span class="player-intro">Ciao, <strong id="playerNameDisplay">...</strong>! üëã</span>

            <div class="question-box" id="questionContent">
                In attesa che la partita inizi...
            </div>

            <!-- Simone Picker UI -->
            <div id="simonePicker" style="display: none;" class="simone-section">
                <div class="simone-badge" id="simoneBadge">üëë Simone: Scegli domanda</div>
                <div class="btn-group-horizontal">
                    <button class="btn btn-sm btn-green" onclick="approveQuestion()">‚úì Approva</button>
                    <button class="btn btn-sm btn-orange" onclick="repickQuestion()">üîÑ Ripesca</button>
                    <button class="btn btn-sm btn-faker" id="btnRevealFaker" onclick="revealFaker()">üîç Faker?</button>
                </div>
            </div>

            <button id="readyBtn" class="btn btn-primary" onclick="markReady()" style="display: none;">
                VOTAZIONE! ‚û°Ô∏è
            </button>

            <div class="progress-section" id="readyStatus" style="display: none;">
                <div class="ready-count-text">
                    <span id="readyCount">0</span> / <span id="totalCount">0</span> pronti
                </div>
                <div id="waitingText" class="waiting-text" style="display: none;">
                    In attesa degli altri giocatori...
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE SUPABASE
        const SUPABASE_URL = 'https://iiwcqemmtdmzzgiytlqr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_pBR3LS6E0PEXe7cbSRuu_g_JOGA9rY-';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const roomId = sessionStorage.getItem('roomId');
        const playerName = sessionStorage.getItem('playerName');

        if (!roomId || !playerName) {
            window.location.href = 'index.html';
        }

        document.getElementById('playerNameDisplay').textContent = playerName;

        let currentRoom = null;
        let activePlayers = [];
        let myPlayer = null;
        let domanda = null;
        let isReady = false;
        let amIEliminated = false;

        async function initGame() {
            const { data: room } = await supabaseClient
                .from('rooms')
                .select('*')
                .eq('id', roomId)
                .single();

            currentRoom = room;

            if (currentRoom.status === 'voting') {
                window.location.href = 'online_game2.html';
                return;
            } else if (currentRoom.status === 'finished') {
                if (currentRoom.winner === 'players') {
                    sessionStorage.setItem('gameResult', 'players_win');
                } else {
                    sessionStorage.setItem('gameResult', 'faker_wins');
                }
                sessionStorage.setItem('faker_name', currentRoom.faker_name || '');
                window.location.href = 'online_end.html';
                return;
            }

            const { data: playersData } = await supabaseClient
                .from('players')
                .select('*')
                .eq('room_id', roomId)
                .order('created_at', { ascending: true });

            const eliminatedPlayers = currentRoom.eliminated_players || [];
            activePlayers = playersData.filter(p => !eliminatedPlayers.includes(p.name));

            myPlayer = playersData.find(p => p.name === playerName);
            amIEliminated = eliminatedPlayers.includes(playerName);

            const readyPlayers = currentRoom.ready_players || [];
            isReady = readyPlayers.includes(playerName);

            const simonePlayer = playersData.find(p => p.name === 'Simone');
            const isSimone = playerName === 'Simone';
            let shouldIPick;

            if (simonePlayer) {
                shouldIPick = isSimone;
            } else {
                shouldIPick = sessionStorage.getItem('isHost') === 'true';
            }

            if (currentRoom.current_question) {
                domanda = currentRoom.current_question;
            } else {
                if (shouldIPick) {
                    const domi = Math.floor(Math.random() * dom.length);
                    domanda = dom[domi];
                    currentRoom.ind = domi;

                    if (isSimone) {
                        showSimonePickerUI(domanda, domi);
                        subscribeToChanges();
                        return;
                    } else {
                        await supabaseClient
                            .from('rooms')
                            .update({
                                current_question: domanda,
                                ready_players: [],
                                ind: domi
                            })
                            .eq('id', roomId);

                        isReady = false;
                    }
                } else {
                    setTimeout(initGame, 1000);
                    return;
                }
            }

            sessionStorage.setItem('onlineDomanda', domanda);

            const ti = document.getElementById("titolo");
            const questionContent = document.getElementById('questionContent');

            if (currentRoom.ind < 109) {
                ti.innerHTML = "üëâ INDICA QUALCUNO";
            } else if (currentRoom.ind < 220) {
                ti.innerHTML = "‚úåÔ∏è ALZA UN NUMERO DI DITA";
            } else {
                ti.innerHTML = "‚úã ALZA LA MANO";
            }

            if (amIEliminated) {
                ti.innerHTML = "OSSERVATORE";
                questionContent.innerHTML = `<span class="eliminated-text">üëª Sei stato eliminato! Guarda gli altri giocare...</span>`;
                document.getElementById('readyBtn').style.display = 'none';
                document.getElementById('readyStatus').style.display = 'block';
            } else if (myPlayer.is_faker) {
                questionContent.innerHTML = '<div><span class="faker-text">üé≠ Sei il FAKER!</span><br><br><small>Rip sei il faker, buona fortuna.</small></div>';
                document.getElementById('readyBtn').style.display = 'block';
                updateReadyUI();
            } else {
                questionContent.innerHTML = `<span>${domanda}</span>`;
                document.getElementById('readyBtn').style.display = 'block';
                updateReadyUI();
            }
            document.getElementById('readyStatus').style.display = 'block';

            checkAllReady();
            subscribeToChanges();
        }

        let currentPickedDomi = null;
        let currentPickedDomanda = null;

        function showSimonePickerUI(question, domi) {
            currentPickedDomi = domi;
            currentPickedDomanda = question;

            const ti = document.getElementById("titolo");
            ti.innerHTML = "SCRUTINIO";

            const questionContent = document.getElementById('questionContent');
            questionContent.innerHTML = `<span>${question}</span>`;

            document.getElementById('simonePicker').style.display = 'block';
            document.getElementById('readyBtn').style.display = 'none';
        }

        async function approveQuestion() {
            await supabaseClient
                .from('rooms')
                .update({
                    current_question: currentPickedDomanda,
                    ready_players: [],
                    ind: currentPickedDomi
                })
                .eq('id', roomId);

            document.getElementById('simonePicker').style.display = 'none';
            document.getElementById('readyBtn').style.display = 'block';
            initGame();
        }

        function repickQuestion() {
            const domi = Math.floor(Math.random() * dom.length);
            const newDomanda = dom[domi];
            showSimonePickerUI(newDomanda, domi);
        }

        async function revealFaker() {
            const { data: playersData } = await supabaseClient
                .from('players')
                .select('name')
                .eq('room_id', roomId)
                .eq('is_faker', true)
                .single();

            const faker = playersData.name;
            document.getElementById('simoneBadge').innerHTML = `üëë Simone | üïµÔ∏è Faker: <strong>${faker}</strong>`;
            document.getElementById('btnRevealFaker').style.display = 'none';
        }

        function updateReadyUI() {
            const readyPlayers = currentRoom.ready_players || [];
            document.getElementById('readyCount').textContent = readyPlayers.length;
            document.getElementById('totalCount').textContent = activePlayers.length;

            const readyBtn = document.getElementById('readyBtn');

            if (isReady) {
                readyBtn.disabled = true;
                readyBtn.innerHTML = '<span>‚è≥</span> ATTENDI...';
                document.getElementById('waitingText').style.display = 'block';
            } else {
                readyBtn.disabled = false;
                readyBtn.innerHTML = 'VOTI! ‚û°Ô∏è';
                document.getElementById('waitingText').style.display = 'none';
            }
        }

        async function markReady() {
            if (isReady || amIEliminated) return;

            isReady = true;
            updateReadyUI();

            const { data: freshRoom } = await supabaseClient
                .from('rooms')
                .select('ready_players')
                .eq('id', roomId)
                .single();

            const currentReady = freshRoom.ready_players || [];
            if (!currentReady.includes(playerName)) {
                currentReady.push(playerName);

                await supabaseClient
                    .from('rooms')
                    .update({ ready_players: currentReady })
                    .eq('id', roomId);
            }
        }

        async function checkAllReady() {
            const readyPlayers = currentRoom.ready_players || [];

            if (readyPlayers.length >= activePlayers.length && activePlayers.length > 0) {
                const sortedReadyPlayers = [...readyPlayers].sort();
                const amIFirstReady = sortedReadyPlayers[0] === playerName;

                if (amIFirstReady && !amIEliminated) {
                    await supabaseClient
                        .from('rooms')
                        .update({ status: 'voting' })
                        .eq('id', roomId)
                        .eq('status', 'playing');
                }
            }
        }

        function subscribeToChanges() {
            supabaseClient
                .channel('room-game-channel-' + roomId + '-' + Date.now())
                .on('postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomId}` },
                    async (payload) => {
                        currentRoom = payload.new;

                        if (currentRoom.status === 'voting') {
                            window.location.href = 'online_game2.html';
                            return;
                        }

                        if (currentRoom.status === 'finished') {
                            if (currentRoom.winner === 'players') {
                                sessionStorage.setItem('gameResult', 'players_win');
                            } else {
                                sessionStorage.setItem('gameResult', 'faker_wins');
                            }
                            sessionStorage.setItem('faker_name', currentRoom.faker_name || '');
                            window.location.href = 'online_end.html';
                            return;
                        }

                        const eliminatedPlayers = currentRoom.eliminated_players || [];
                        if (eliminatedPlayers.includes(playerName) && !amIEliminated) {
                            amIEliminated = true;
                            const questionContent = document.getElementById('questionContent');
                            document.getElementById("titolo").innerHTML = "OSSERVATORE";
                            questionContent.innerHTML = `<span class="eliminated-text">üëª Sei stato eliminato! Guarda gli altri giocare...</span>`;
                            document.getElementById('readyBtn').style.display = 'none';
                        }

                        if (!amIEliminated) {
                            const { data: playersData } = await supabaseClient
                                .from('players')
                                .select('*')
                                .eq('room_id', roomId);
                            activePlayers = playersData.filter(p => !eliminatedPlayers.includes(p.name));

                            updateReadyUI();
                            checkAllReady();
                        }
                    }
                )
                .subscribe();
        }

        initGame();
    </script>
</body>

</html>