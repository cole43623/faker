<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votazione Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #6f42c1;
            color: #fff;
            min-height: 50vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .container {
            text-align: center;
            width: 100%;
            max-width: 600px;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 2rem;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .rounded-button {
            padding: 1em 2em;
            border: none;
            border-radius: 20px;
            background-color: #fff;
            color: #6f42c1;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            width: 100%;
            max-width: 250px;
        }

        .rounded-button:hover {
            background-color: #5a359d;
            color: #fff;
        }

        .rounded-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .voted {
            background-color: #04AA6D !important;
            color: white !important;
        }

        .vote-count {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 0.2rem 0.5rem;
            border-radius: 50%;
            margin-left: 0.5rem;
            font-size: 0.9rem;
        }

        .waiting-message {
            font-size: 1.2rem;
            margin: 2rem 0;
            animation: pulse 1.5s infinite;
        }

        .eliminated-notice {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .your-vote-indicator {
            color: #04AA6D;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .you-badge {
            background-color: #f39c12;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 0.3rem;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        /* Modal Popup Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: linear-gradient(135deg, #5a359d 0%, #6f42c1 100%);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            max-width: 90%;
            width: 350px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        }

        .modal-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .modal-message {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
        }

        .modal-button {
            padding: 0.8em 2em;
            border: none;
            border-radius: 25px;
            background-color: #fff;
            color: #6f42c1;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .modal-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.3);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: scale(0.8) translateY(-20px);
                opacity: 0;
            }

            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.1rem;
            }

            .rounded-button {
                font-size: 1.6rem;
                padding: 0.8em 1.5em;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 2rem;
            }

            .rounded-button {
                font-size: 1.4rem;
                padding: 0.8em 1.3em;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>"<span id="dom"></span>"<br><br>VOTATE CHI ELIMINARE</h1>
        <div id="button-container"></div>
        <div id="waitingStatus"></div>
    </div>

    <!-- Modal Popup -->
    <div id="resultModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">üëª</div>
            <div class="modal-title" id="modalTitle">Risultato</div>
            <div class="modal-message" id="modalMessage">Messaggio</div>
            <button class="modal-button" onclick="closeModalAndContinue()">Continua</button>
        </div>
    </div>

    <!-- Confirm Vote Modal -->
    <div id="confirmVoteModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-icon">ü§î</div>
            <div class="modal-title">Conferma Voto</div>
            <div class="modal-message">Vuoi davvero eliminare <span id="confirmVoteName"></span>?</div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="modal-button" style="background-color: #6c757d; color: white;"
                    onclick="closeConfirmModal()">Annulla</button>
                <button class="modal-button" style="background-color: #04AA6D; color: white;"
                    id="confirmVoteBtn">Conferma</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE SUPABASE
        const SUPABASE_URL = 'https://iiwcqemmtdmzzgiytlqr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_pBR3LS6E0PEXe7cbSRuu_g_JOGA9rY-';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const roomId = sessionStorage.getItem('roomId');
        const playerName = sessionStorage.getItem('playerName');
        const isHost = sessionStorage.getItem('isHost') === 'true';

        if (!roomId || !playerName) {
            window.location.href = 'index.html';
        }

        let allPlayers = [];
        let activePlayers = []; // Solo giocatori non eliminati
        let votes = {};
        let myVote = null;
        let currentRoom = null;
        let amIEliminated = false;
        let pendingRedirect = null;

        // Funzioni per il modal popup
        function showResultModal(icon, title, message) {
            document.getElementById('modalIcon').textContent = icon;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('resultModal').style.display = 'flex';
        }

        function closeModalAndContinue() {
            document.getElementById('resultModal').style.display = 'none';
            if (pendingRedirect) {
                window.location.href = pendingRedirect;
            }
        }

        function closeConfirmModal() {
            document.getElementById('confirmVoteModal').style.display = 'none';
        }

        async function initVoting() {
            // Mostra la domanda
            const domanda = sessionStorage.getItem('onlineDomanda') || 'Indica qualcuno...';
            document.getElementById('dom').textContent = domanda;

            // Carica i giocatori
            const { data: playersData } = await supabaseClient
                .from('players')
                .select('*')
                .eq('room_id', roomId)
                .order('created_at', { ascending: true });

            allPlayers = playersData;

            // Carica la stanza
            const { data: room } = await supabaseClient
                .from('rooms')
                .select('*')
                .eq('id', roomId)
                .single();

            currentRoom = room;
            votes = currentRoom.votes || {};

            // Filtra i giocatori eliminati
            const eliminatedPlayers = currentRoom.eliminated_players || [];
            activePlayers = allPlayers.filter(p => !eliminatedPlayers.includes(p.name));
            amIEliminated = eliminatedPlayers.includes(playerName);

            // Controlla lo stato della stanza (redirect se necessario)
            if (currentRoom.status === 'finished') {
                if (currentRoom.winner === 'players') {
                    sessionStorage.setItem('gameResult', 'players_win');
                } else {
                    sessionStorage.setItem('gameResult', 'faker_wins');
                }
                sessionStorage.setItem('eliminated', currentRoom.eliminated || '');
                window.location.href = 'online_end.html';
                return;
            } else if (currentRoom.status === 'playing') {
                // Pulisci la domanda dalla sessione
                sessionStorage.removeItem('onlineDomanda');
                window.location.href = 'online_game1.html';
                return;
            }

            // Se sono eliminato, mostro solo lo stato di osservatore
            if (amIEliminated) {
                showEliminatedState();
                subscribeToVotes();
                return;
            }

            // Controlla se ho gia votato
            if (votes[playerName]) {
                myVote = votes[playerName];
            }

            renderButtons();
            subscribeToVotes();

            // Controlla se tutti hanno gia votato (in caso di rejoin)
            checkAllVoted();
        }

        function showEliminatedState() {
            const domanda = sessionStorage.getItem('onlineDomanda') || '';
            document.querySelector('h1').innerHTML = `"${domanda}"<br><br>üëª Sei stato eliminato`;
            document.getElementById('button-container').innerHTML =
                '<div class="eliminated-notice">Stai guardando come spettatore</div>';
            updateWaitingStatus();
        }

        function renderButtons() {
            const buttonContainer = document.getElementById('button-container');
            buttonContainer.innerHTML = '';

            // Mostra solo i giocatori attivi (non eliminati)
            activePlayers.forEach((player) => {
                const buttonWrapper = document.createElement('div');
                buttonWrapper.classList.add('button-container');

                const button = document.createElement('button');
                button.classList.add('rounded-button');

                // Conta i voti per questo giocatore
                const voteCount = Object.values(votes).filter(v => v === player.name).length;

                let buttonText = player.name;

                // Aggiungi badge "TU" se √® il giocatore corrente
                if (player.name === playerName) {
                    buttonText += ' <span class="you-badge">TU</span>';
                }

                if (voteCount > 0) {
                    buttonText += ` <span class="vote-count">${voteCount}</span>`;
                }
                if (myVote === player.name) {
                    buttonText += '<span class="your-vote-indicator"> (tuo voto)</span>';
                    button.classList.add('voted');
                }

                button.innerHTML = buttonText;
                button.disabled = myVote !== null;
                button.onclick = () => confirmVote(player.name);

                buttonWrapper.appendChild(button);
                buttonContainer.appendChild(buttonWrapper);
            });

            updateWaitingStatus();
        }

        function updateWaitingStatus() {
            const waitingStatus = document.getElementById('waitingStatus');
            const votedCount = Object.keys(votes).length;

            if (amIEliminated || myVote) {
                waitingStatus.innerHTML = `<div class="waiting-message">In attesa degli altri giocatori... (${votedCount}/${activePlayers.length})</div>`;
            } else {
                waitingStatus.innerHTML = '';
            }
        }

        async function confirmVote(votedFor) {
            if (myVote || amIEliminated) return;

            document.getElementById('confirmVoteName').textContent = votedFor;
            document.getElementById('confirmVoteModal').style.display = 'flex';

            document.getElementById('confirmVoteBtn').onclick = () => {
                closeConfirmModal();
                castVote(votedFor);
            };
        }

        async function castVote(votedFor) {
            if (myVote || amIEliminated) return;

            myVote = votedFor;

            // Ricarica i voti freschi per evitare conflitti
            const { data: freshRoom } = await supabaseClient
                .from('rooms')
                .select('votes')
                .eq('id', roomId)
                .single();

            const updatedVotes = freshRoom.votes || {};
            updatedVotes[playerName] = votedFor;

            await supabaseClient
                .from('rooms')
                .update({ votes: updatedVotes })
                .eq('id', roomId);

            votes = updatedVotes;
            renderButtons();

            // Controlla se tutti hanno votato
            checkAllVoted();
        }

        async function checkAllVoted() {
            // Ricarica i voti freschi dal database
            const { data: freshRoom } = await supabaseClient
                .from('rooms')
                .select('votes, status')
                .eq('id', roomId)
                .single();

            // Se lo status √® gi√† cambiato, non fare nulla
            if (freshRoom.status !== 'voting') return;

            const freshVotes = freshRoom.votes || {};
            const votedCount = Object.keys(freshVotes).length;

            // Solo i giocatori attivi devono votare
            if (votedCount >= activePlayers.length && activePlayers.length > 0) {
                // Determina chi processa il risultato:
                // Il primo votante in ordine alfabetico (per evitare che tutti processino)
                const sortedVoters = Object.keys(freshVotes).sort();
                const amIFirstVoter = sortedVoters[0] === playerName;

                if (!amIFirstVoter) return;

                // Trova chi ha ricevuto piu voti
                const voteCounts = {};
                Object.values(freshVotes).forEach(v => {
                    voteCounts[v] = (voteCounts[v] || 0) + 1;
                });

                // Trova il numero massimo di voti
                const maxVotes = Math.max(...Object.values(voteCounts));

                // Trova tutti i giocatori con il massimo di voti (per controllare pareggio)
                const playersWithMaxVotes = Object.entries(voteCounts)
                    .filter(([name, count]) => count === maxVotes)
                    .map(([name]) => name);

                // Se c'√® un pareggio, nessuno viene eliminato
                if (playersWithMaxVotes.length > 1) {
                    // Pareggio! Nessuno eliminato, si va al prossimo round
                    await supabaseClient
                        .from('rooms')
                        .update({
                            status: 'playing',
                            current_question: null,
                            votes: {},
                            ready_players: [],
                            last_eliminated: null // Nessuno eliminato
                        })
                        .eq('id', roomId);
                    return;
                }

                const eliminated = playersWithMaxVotes[0];

                // Trova il giocatore eliminato
                const eliminatedPlayer = allPlayers.find(p => p.name === eliminated);

                if (eliminatedPlayer && eliminatedPlayer.is_faker) {
                    // Il faker e stato trovato!
                    await supabaseClient
                        .from('rooms')
                        .update({ status: 'finished', winner: 'players', eliminated: eliminated })
                        .eq('id', roomId);
                } else {
                    // Giocatore innocente eliminato - aggiungi alla lista degli eliminati
                    const currentEliminated = currentRoom.eliminated_players || [];
                    currentEliminated.push(eliminated);

                    // Controlla quanti giocatori attivi rimangono
                    const remainingPlayers = activePlayers.length - 1;

                    if (remainingPlayers <= 2) {
                        // Il faker vince!
                        await supabaseClient
                            .from('rooms')
                            .update({
                                status: 'finished',
                                winner: 'faker',
                                eliminated: eliminated,
                                eliminated_players: currentEliminated
                            })
                            .eq('id', roomId);
                    } else {
                        // Continua il gioco
                        await supabaseClient
                            .from('rooms')
                            .update({
                                status: 'playing',
                                current_question: null, // Resetta la domanda per il nuovo round
                                votes: {},
                                ready_players: [],
                                last_eliminated: eliminated,
                                eliminated_players: currentEliminated
                            })
                            .eq('id', roomId);
                    }
                }
            }
        }

        function subscribeToVotes() {
            supabaseClient
                .channel('votes-channel-' + roomId + '-' + Date.now())
                .on('postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomId}` },
                    async (payload) => {
                        currentRoom = payload.new;
                        votes = currentRoom.votes || {};

                        // Aggiorna la lista dei giocatori eliminati
                        const eliminatedPlayers = currentRoom.eliminated_players || [];
                        activePlayers = allPlayers.filter(p => !eliminatedPlayers.includes(p.name));

                        if (currentRoom.status === 'finished') {
                            // Reindirizza alla pagina finale
                            if (currentRoom.winner === 'players') {
                                sessionStorage.setItem('gameResult', 'players_win');
                            } else {
                                sessionStorage.setItem('gameResult', 'faker_wins');
                            }
                            sessionStorage.setItem('eliminated', currentRoom.eliminated || '');
                            window.location.href = 'online_end.html';
                        } else if (currentRoom.status === 'playing') {
                            // Mostra chi e stato eliminato e torna al gioco
                            const eliminated = currentRoom.last_eliminated;
                            // Pulisci la domanda dalla sessione
                            sessionStorage.removeItem('onlineDomanda');
                            pendingRedirect = 'online_game1.html';

                            if (eliminated) {
                                showResultModal('üòµ', 'Eliminato!', eliminated + ' era innocente ed √® stato eliminato.');
                            } else {
                                showResultModal('‚öñÔ∏è', 'Pareggio!', 'Nessuno √® stato eliminato. Si va al prossimo round!');
                            }
                        } else {
                            if (!amIEliminated) {
                                renderButtons();
                                // Controlla se tutti hanno votato dopo ogni aggiornamento
                                checkAllVoted();
                            } else {
                                updateWaitingStatus();
                            }
                        }
                    }
                )
                .subscribe();
        }

        initVoting();
    </script>
</body>

</html>